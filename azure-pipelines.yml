# azure-pipelines.yml
trigger:
  branches:
    include:
      - main  # adapte selon ta branche principale

pool:
  name: Default

variables:
  MAVEN_OPTS: '-Xmx1024m'
  JAR_FILE: 'target/AnnotationPlatfrom-0.0.1-SNAPSHOT.jar'

steps:
# 1️⃣ Checkout du code
- checkout: self
  displayName: 'Checkout repository'

# 2️⃣ Build Maven
- task: Maven@3
  displayName: 'Build Maven project'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'

# 3️⃣ Run tests (optionnel)
- task: Maven@4
  displayName: 'Run Tests'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'test'

# 4️⃣ Publish artifact pour Azure Pipelines
- task: PublishBuildArtifacts@1
  displayName: 'Publish JAR artifact'
  inputs:
    pathToPublish: '$(JAR_FILE)'
    artifactName: 'drop'
    publishLocation: 'Container'

# 5️⃣ Copier le JAR dans le dossier de staging pour le déploiement
- task: CopyFiles@2
  displayName: 'Copy JAR to staging directory for deployment'
  inputs:
    SourceFolder: 'target'
    Contents: 'AnnotationPlatfrom-0.0.1-SNAPSHOT.jar'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'

# 6️⃣ Déployer sur Azure App Service
- task: AzureWebApp@1
  displayName: 'Deploy to Azure App Service'
  inputs:
    azureSubscription: 'AzureConnectionAnnotation' # nom exact de ta connexion de service
    appName: 'annotation-platform-app'             # nom exact de ton App Service
    package: '$(Build.ArtifactStagingDirectory)/AnnotationPlatfrom-0.0.1-SNAPSHOT.jar'
