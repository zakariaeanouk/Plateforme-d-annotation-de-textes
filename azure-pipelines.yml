# azure-pipelines.yml
trigger:
  branches:
    include:
      - main  # déploie uniquement quand on push sur main

pool:
  vmImage: 'ubuntu-latest'   # ✅ Utilise une machine hébergée par Microsoft (plus stable que Default)

variables:
  MAVEN_OPTS: '-Xmx1024m'
  JAR_FILE: 'target/AnnotationPlatfrom-0.0.1-SNAPSHOT.jar'

steps:
# 1️⃣ Checkout du code
- checkout: self
  displayName: 'Checkout repository'

# 2️⃣ Setup JDK (important pour Maven)
- task: UseJavaVersion@1
  displayName: 'Set up Java 17'
  inputs:
    versionSpec: '17'
    jdkArchitecture: 'x64'

# 3️⃣ Build Maven project
- task: Maven@4
  displayName: 'Build Maven project'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package -DskipTests'   # skipTests pour accélérer le build
    publishJUnitResults: false

# 4️⃣ Publish artifact
- task: PublishBuildArtifacts@1
  displayName: 'Publish JAR artifact'
  inputs:
    pathToPublish: '$(JAR_FILE)'
    artifactName: 'drop'
    publishLocation: 'Container'

# 5️⃣ Deploy to Azure App Service
- task: AzureWebApp@1
  displayName: 'Deploy to Azure App Service'
  inputs:
    azureSubscription: 'AzureConnectionAnnotation'   # nom exact de la connexion de service (à vérifier)
    appName: 'annotation-platform-app'               # nom exact de ton App Service
    package: '$(System.DefaultWorkingDirectory)/target/AnnotationPlatfrom-0.0.1-SNAPSHOT.jar'  # ✅ chemin complet vers le JAR
